pipeline {
    agent any

    environment {
        JAVA_HOME = tool name: 'jdk17', type: 'jdk'
        MAVEN_HOME = tool name: 'maven3', type: 'maven'
        PATH = "${JAVA_HOME}\\bin;${MAVEN_HOME}\\bin;${env.PATH}"

        SONAR_HOST_URL = 'http://localhost:9000'
        SONAR_PROJECT_KEY = 'medicore'
        SONAR_PROJECT_NAME = 'MediCore Healthcare Platform'
        PROJECT_DIR = 'projet'
    }

    options {
        timestamps()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 45, unit: 'MINUTES')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo "Code recupere avec succes"
            }
        }

        stage('Build (Skip Tests)') {
            steps {
                echo "Compilation sans tests..."
                dir("${PROJECT_DIR}") {
                    script {
                        def services = [
                            'api-gateway',
                            'auth-service',
                            'cabinet-service',
                            'patient-service',
                            'rendezVous-service',
                            'facture-service',
                            'consultation-service',
                            'medicament-service'
                        ]

                        for (service in services) {
                            dir(service) {
                                bat 'mvn -B clean compile -DskipTests'
                            }
                        }
                    }
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo "Analyse SonarQube en cours..."
                withSonarQubeEnv('SonarQube') {
                    dir("${PROJECT_DIR}") {
                        script {
                            def services = [
                                'api-gateway',
                                'auth-service',
                                'cabinet-service',
                                'patient-service',
                                'rendezVous-service',
                                'facture-service',
                                'consultation-service',
                                'medicament-service'
                            ]

                            for (service in services) {
                                dir(service) {
                                    bat """mvn -B sonar:sonar ^
                                        -DskipTests ^
                                        -Dsonar.projectKey=${SONAR_PROJECT_KEY}-${service} ^
                                        -Dsonar.projectName="${SONAR_PROJECT_NAME} - ${service}" ^
                                        -Dsonar.host.url=${SONAR_HOST_URL} ^
                                        -Dsonar.java.source=17"""
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                echo "Verification Quality Gate..."
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline termine avec succes!'
        }
        failure {
            echo 'Pipeline echoue!'
        }
        always {
            cleanWs()
        }
    }
}
